<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Layout Editor</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header h1 {
      color: #0d3775;
      margin-bottom: 8px;
    }
    .header p {
      color: #666;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #0d3775;
      color: white;
    }
    .btn-primary:hover {
      background: #0a2855;
    }
    .btn-secondary {
      background: #e0e5eb;
      color: #333;
    }
    .btn-secondary:hover {
      background: #d0d5dd;
    }
    .editor {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .preview-container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-height: 600px;
    }
    .preview-container h2 {
      color: #0d3775;
      margin-bottom: 16px;
      font-size: 18px;
    }
    .page {
      border: 2px solid #d0d5dd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: #fafbfc;
    }
    .page-header {
      font-weight: 600;
      color: #0d3775;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .page-layout {
      display: grid;
      gap: 12px;
    }
    .page-layout.two-col {
      grid-template-columns: 1fr 1fr;
    }
    .section-card {
      background: white;
      border: 2px solid #e0e5eb;
      border-radius: 8px;
      padding: 12px;
      cursor: move;
      transition: all 0.2s;
      position: relative;
    }
    .section-card:hover {
      border-color: #0d3775;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    .section-card.drag-over {
      border-color: #4caf50;
      border-style: dashed;
      background: #f1f8f4;
    }
    .section-card.full-width {
      grid-column: 1 / -1;
    }
    .section-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .section-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #666;
    }
    .control-btn {
      padding: 4px 8px;
      border: 1px solid #d0d5dd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .control-btn:hover {
      background: #f0f4f8;
      border-color: #0d3775;
    }
    .control-btn.active {
      background: #0d3775;
      color: white;
      border-color: #0d3775;
    }
    .drag-handle {
      position: absolute;
      top: 8px;
      right: 8px;
      color: #999;
      font-size: 18px;
      cursor: move;
    }
    .section-preview {
      font-size: 10px;
      color: #999;
      margin-top: 4px;
    }
    input[type="file"] {
      display: none;
    }
    .file-input-label {
      display: inline-block;
      padding: 10px 20px;
      background: #e0e5eb;
      color: #333;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-input-label:hover {
      background: #d0d5dd;
    }
    .status {
      display: inline-block;
      margin-left: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .status.success {
      background: #e6f4ea;
      color: #137333;
    }
    .status.error {
      background: #fce8e6;
      color: #c5221f;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const SECTION_METADATA = {
      professional_summary: { name: 'Professional Summary', allowColumns: false, defaultWidth: 'full' },
      technical_expertise: { name: 'Technical Expertise', allowColumns: true, defaultWidth: 'full', maxColumns: 4 },
      experience: { name: 'Experience', allowColumns: false, defaultWidth: 'full' },
      projects: { name: 'Projects', allowColumns: false, defaultWidth: 'full' },
      work_samples: { name: 'Work Samples', allowColumns: true, defaultWidth: 'half', maxColumns: 2 },
      education: { name: 'Education', allowColumns: false, defaultWidth: 'half' },
      publications: { name: 'Publications', allowColumns: false, defaultWidth: 'half' },
      certifications: { name: 'Certifications', allowColumns: false, defaultWidth: 'half' },
      achievements: { name: 'Achievements', allowColumns: false, defaultWidth: 'half' },
      leadership_mentoring: { name: 'Leadership', allowColumns: false, defaultWidth: 'half' }
    };

    function SectionCard({ section, config, onUpdateConfig, index, onDragStart, onDragEnd, onDragOver, onDrop, isDragging, isDragOver }) {
      const metadata = SECTION_METADATA[section] || { name: section, allowColumns: false };
      
      // Provide default config if undefined
      const safeConfig = config || { width: metadata.defaultWidth || 'full', columns: 1 };
      
      const toggleWidth = () => {
        const newWidth = safeConfig.width === 'full' ? 'half' : 'full';
        onUpdateConfig(section, { ...safeConfig, width: newWidth });
      };

      const updateColumns = (delta) => {
        const newColumns = Math.max(1, Math.min((safeConfig.columns || 1) + delta, metadata.maxColumns || 4));
        onUpdateConfig(section, { ...safeConfig, columns: newColumns });
      };

      return (
        <div
          className={`section-card ${safeConfig.width === 'full' ? 'full-width' : ''} ${isDragging ? 'dragging' : ''} ${isDragOver ? 'drag-over' : ''}`}
          draggable
          onDragStart={(e) => onDragStart(e, index)}
          onDragEnd={onDragEnd}
          onDragOver={(e) => onDragOver(e, index)}
          onDrop={(e) => onDrop(e, index)}
        >
          <div className="drag-handle">⋮⋮</div>
          <div className="section-name">{metadata.name}</div>
          <div className="section-controls">
            <div className="control-group">
              <button 
                className={`control-btn ${safeConfig.width === 'full' ? 'active' : ''}`}
                onClick={toggleWidth}
              >
                Full
              </button>
              <button 
                className={`control-btn ${safeConfig.width === 'half' ? 'active' : ''}`}
                onClick={toggleWidth}
              >
                Half
              </button>
            </div>
            {metadata.allowColumns && (
              <div className="control-group">
                <span>Cols:</span>
                <button className="control-btn" onClick={() => updateColumns(-1)}>−</button>
                <span style={{minWidth: '20px', textAlign: 'center'}}>{safeConfig.columns || 1}</span>
                <button className="control-btn" onClick={() => updateColumns(1)}>+</button>
              </div>
            )}
          </div>
          <div className="section-preview">
            {safeConfig.width} width{metadata.allowColumns ? `, ${safeConfig.columns || 1} column${(safeConfig.columns || 1) > 1 ? 's' : ''}` : ''}
          </div>
        </div>
      );
    }

    function App() {
      const [resumeData, setResumeData] = useState(null);
      const [layoutConfig, setLayoutConfig] = useState({});
      const [sectionOrder, setSectionOrder] = useState([]);
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [dragOverIndex, setDragOverIndex] = useState(null);
      const [status, setStatus] = useState(null);

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            setResumeData(data);
            
            // Initialize layout config from data or defaults
            const sections = Object.keys(SECTION_METADATA).filter(key => data[key]);
            setSectionOrder(sections);
            
            const initialConfig = {};
            sections.forEach(section => {
              const existingWidth = data.layout_config?.section_widths?.[section];
              const existingColumns = data.layout_config?.section_columns?.[section];
              initialConfig[section] = {
                width: existingWidth || SECTION_METADATA[section].defaultWidth || 'full',
                columns: existingColumns || 1
              };
            });
            setLayoutConfig(initialConfig);
            setStatus({ type: 'success', message: 'Resume loaded successfully!' });
            setTimeout(() => setStatus(null), 3000);
          } catch (err) {
            setStatus({ type: 'error', message: 'Error parsing JSON file' });
            setTimeout(() => setStatus(null), 3000);
          }
        };
        reader.readAsText(file);
      };

      const handleUpdateConfig = (section, newConfig) => {
        setLayoutConfig(prev => ({
          ...prev,
          [section]: newConfig
        }));
      };

      const handleDragStart = (e, index) => {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragEnd = () => {
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const handleDragOver = (e, index) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (index !== draggedIndex) {
          setDragOverIndex(index);
        }
      };

      const handleDrop = (e, dropIndex) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === dropIndex) return;

        const newOrder = [...sectionOrder];
        const [draggedSection] = newOrder.splice(draggedIndex, 1);
        newOrder.splice(dropIndex, 0, draggedSection);
        
        setSectionOrder(newOrder);
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const exportConfig = () => {
        if (!resumeData) return;

        const updatedData = {
          ...resumeData,
          layout_config: {
            ...resumeData.layout_config,
            section_order: sectionOrder,
            section_widths: Object.fromEntries(
              Object.entries(layoutConfig).map(([key, val]) => [key, val.width])
            ),
            section_columns: Object.fromEntries(
              Object.entries(layoutConfig)
                .filter(([key, val]) => SECTION_METADATA[key]?.allowColumns)
                .map(([key, val]) => [key, val.columns])
            )
          }
        };

        const blob = new Blob([JSON.stringify(updatedData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resume-updated.json';
        a.click();
        URL.revokeObjectURL(url);
        
        setStatus({ type: 'success', message: 'Layout configuration exported!' });
        setTimeout(() => setStatus(null), 3000);
      };

      const renderPreview = () => {
        if (sectionOrder.length === 0) return null;

        const pages = [{ full: [], left: [], right: [] }];
        let currentPage = 0;

        sectionOrder.forEach(section => {
          const config = layoutConfig[section];
          if (!config) return;

          if (config.width === 'full') {
            pages[currentPage].full.push(section);
          } else {
            // Simple alternating logic - can be enhanced
            if (pages[currentPage].left.length <= pages[currentPage].right.length) {
              pages[currentPage].left.push(section);
            } else {
              pages[currentPage].right.push(section);
            }
          }
        });

        return pages.map((page, pageIndex) => (
          <div key={pageIndex} className="page">
            <div className="page-header">Page {pageIndex + 1}</div>
            <div className="page-layout two-col">
              <div>
                {page.full.map((section, idx) => (
                  <SectionCard
                    key={section}
                    section={section}
                    config={layoutConfig[section]}
                    onUpdateConfig={handleUpdateConfig}
                    index={sectionOrder.indexOf(section)}
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    isDragging={draggedIndex === sectionOrder.indexOf(section)}
                    isDragOver={dragOverIndex === sectionOrder.indexOf(section)}
                  />
                ))}
                {page.left.map((section, idx) => (
                  <SectionCard
                    key={section}
                    section={section}
                    config={layoutConfig[section]}
                    onUpdateConfig={handleUpdateConfig}
                    index={sectionOrder.indexOf(section)}
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    isDragging={draggedIndex === sectionOrder.indexOf(section)}
                    isDragOver={dragOverIndex === sectionOrder.indexOf(section)}
                  />
                ))}
              </div>
              <div>
                {page.right.map((section, idx) => (
                  <SectionCard
                    key={section}
                    section={section}
                    config={layoutConfig[section]}
                    onUpdateConfig={handleUpdateConfig}
                    index={sectionOrder.indexOf(section)}
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    isDragging={draggedIndex === sectionOrder.indexOf(section)}
                    isDragOver={dragOverIndex === sectionOrder.indexOf(section)}
                  />
                ))}
              </div>
            </div>
          </div>
        ));
      };

      return (
        <div className="container">
          <div className="header">
            <h1>Resume Layout Editor</h1>
            <p>Upload your resume JSON, drag sections to reorder, adjust widths and columns, then export.</p>
            <div className="controls">
              <input type="file" id="file-upload" accept=".json" onChange={handleFileUpload} />
              <label htmlFor="file-upload" className="file-input-label">
                Upload Resume JSON
              </label>
              <button 
                className="btn btn-primary" 
                onClick={exportConfig}
                disabled={!resumeData}
              >
                Export Layout Config
              </button>
              {status && (
                <span className={`status ${status.type}`}>
                  {status.message}
                </span>
              )}
            </div>
          </div>

          {resumeData ? (
            <div className="editor">
              <div className="preview-container">
                <h2>All Sections (Drag to Reorder)</h2>
                {sectionOrder.map((section, index) => (
                  <SectionCard
                    key={section}
                    section={section}
                    config={layoutConfig[section]}
                    onUpdateConfig={handleUpdateConfig}
                    index={index}
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    isDragging={draggedIndex === index}
                    isDragOver={dragOverIndex === index}
                  />
                ))}
              </div>
              <div className="preview-container">
                <h2>Layout Preview</h2>
                {renderPreview()}
              </div>
            </div>
          ) : (
            <div className="preview-container">
              <p style={{textAlign: 'center', color: '#666', padding: '60px 20px'}}>
                Upload a resume JSON file to get started
              </p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>